 \begin{description}
   	 \item[\boldmath{$RCCA3.\KeyGen(1^\lambda)$}]:
      \begin{enumerate}
      \item Choose a asymmetric pairing group system $(\G, \hat{\G}, \G_T)$, groups of prime order $p > 2^\lambda$.
      \item Set $\PPP$ as $(\G, \hat{\G}, \G_T)$.
      \item Choose also group generators $g_1, g_2 \sample \G$ and random values $x_1, x_2 \sample \mathbb{Z}_p$.
      \item Generate group generator $\hat{g} \sample \hat{\G}$
      \item Set $X = g_1^{x_1}g_2^{x_2}$.
      \item Generate random values $\rho_u$ and random group generators $(\hat{g}, \hat{h}) \sample \hat{\G}^2$.
      \item Set $(\vec{u}_1, \vec{u}_2)$ as $\vec{u}_1 = (\hat{g}, \hat{h}) \in \hat{\G}^2$ and $\vec{u}_2 = (\vec{u}_1)^{\rho_u} = (\hat{g}^{\rho_u}, \hat{h}^{\rho_u}) \in \hat{\G}^2$.
      \item $\PPP_{TC} = (\PPP, g_1, \hat{g}, \ell = 6)$.
      \item Generate the commitment key $\vec{\ck} \in \hat{\G}^8$ and $\vec{\tk} \in \mathbb{Z}_p^8$.
      \item Generate a pair of Groth-Sahai commitment parameters$(\PPP_{GS})$.
      \item $\SK = (x_1, x_2)$
      \item $\PK = (g_1, g_2, \vec{u}_1, \vec{u}_2, X, \PPP_{TC}, \vec{\ck}, \PPP_{GS})$
      \end{enumerate}
    \item[\boldmath{$RCCA3.\Enc(M,\PK)$}]:
      \begin{enumerate}
      \item Generate the LHSPS signature keys $(\SSK, \SVK) \gets LHSPS.\KeyGen(\PPP)$ with $\SSK = (\{\chi_i, \gamma_i\}_{i=1}^5) \in \mathbb{Z}_p^{10}$ and $\SVK = (\{\SVK_i\}_{i=1}^5) = (\{\hat{g}_i\}_{i =1}^5) \in \hat{\G}^5$.
      \item Choose $\theta \sample \mathbb{Z}_p$ and compute
        \begin{align*}
          C_0 &= M\cdot X^{\theta}, & C_1 &= g_1^{\theta}, & C_2 &= g_2^{\theta}.
        \end{align*}
      \item Generate commitment and open of the verification key $\SVK$, 
      $$(\com, \open) \gets TC.\Com(\PPP_{TC}, \vec{ck}, \SVK) \in \hat{\G} \times (\G^9 \times \hat{\G}^2)$$
      \item Construct the proof vector $\vec{u}_{\com} = \vec{u}_2\cdot (1, \com)$. 
      \item Generate $r \sample \mathbb{Z}_p$. Compute $\vec{C}_{\theta} = \vec{u}_{\com}^{\theta} \cdot (\vec{u}_1)^r$.
      \item Using $\vec{C}_{\theta}$ to get two GS proofs $\vec{\pi}$ of
        \begin{align*}
          C_1 &= g_1^{\theta} & C_2 &= g_2^{\theta}
        \end{align*}
      \item Generate the commitment $\vec{C}_{\SVK}, \vec{C}_{\com}, \vec{C}_{\open}$ of $\SVK, \com, \open$ with respect to $\PPP_{GS}$.
      \item Generate the proof $(\vec{\pi}_{\com}, \vec{\pi}_{proof})$ of the following equations:
      \begin{align*}
      	TC.\Verif(\ck, \com, \SVK, \open) &= \True & GS.\Verif(\vec{\pi}, \{\vec{C}_{theta}\}, \{\vec{u_1}, \vec{u_2} \cdot (1, \com)\}) &= \True
      \end{align*}
      
      More explicitly, We parse $\open$ as $(D, g_z, g_1, \dots, g_5, \ovk_{POS}, \hat{Z}, \hat{R}) \in \G^8 \times \hat{\G}^2$, then we have $\vec{C}_{\open} \in \G^{16} \cdot \hat{\G}^4$, then we proof the following equations:
      \begin{align*}
	e(g, \hat{C}) &= e(D, \hat{g}) \prod_{i = 1}^{5} e(\SVK_i, \hat{X}_i) \cdot e(g_z, \hat{X}_6) \cdot e(\ovk_{POS}, \hat{X}_7) & e(\ovk_{POS}, \hat{g}) &= e(g_z, \hat{Z}) \cdot e(g, \hat{R}) \cdot \prod_{i = 1}^\ell e(g_i, \SVK_i) 
      \end{align*}
      Then we have $\pi_{\com} \in \G^2 \times \hat{G}^2$.
      
      We Parse $\vec{\pi}$ with $(\pi_1, \pi_2)$, the we generate the GS proof for the following equations:
      \begin{align*}
      E(g_1, \vec{C}_\theta) &= E(C_1, \vec{u}_2) \cdot E(C_1, (1, \com)) \cdot E(\pi_1, \vec{u}_1)\\
      E(g_2, \vec{C}_\theta) &= E(C_2, \vec{u}_2) \cdot E(C_2, (1, \com)) \cdot E(\pi_2, \vec{u}_1)
      \end{align*}
      Thus we have $\vec{\pi}_{proof} \in \G^4$.
      \item Output the ciphertext
        \begin{align*}
          \vec{C} = (C_0, C_1, C_2, \vec{C}_{\theta}, \vec{\pi}, \vec{\sigma}, \vec{\sigma_{r_1}}, \vec{\sigma_{r_2}}, \vec{C}_{\SVK}, \vec{C}_{\com}, \vec{C}_{\open},  \vec{\pi}_{\com}, \vec{\pi}_{proof}) \in \G^{42} \times \hat{\G}^{23}
        \end{align*}
        
        
        in which $\vec{\sigma} = LSHSPS.\Sig(\SSK, (C_0, C_1, C_2, \vec{\pi})) \in \G^2$, $\vec{\sigma_r} = LHSPS.\Sig(\SSK, (X, g_1, g_2, 1, 1))$ and $\vec{\sigma_r} = LHSPS.\Sig(\SSK, (1, 1, 1, g_1, g_2))$.
        Notice that we don't sign the commitments because in the Groth-Sahai proof system and in this very special case, there is only one valid commitment for given proofs.
        
        
        
      \end{enumerate}
      
    \item[\boldmath{$RCCA3.\Dec(\PK, \vec{C}, \SK)$}]:
      \begin{enumerate}
      \item Parse $\PK$ with $(\vec{g}_1, \vec{g}_2, X, \PPP_{TC}, \ck)$ and $\SK$ with $(x_1, x_2)$.
      \item Parse $\vec{C}$ with $ (\SVK, \com, \open, C_0, C_1, C_2, \vec{C}_{\theta}, \vec{\pi}, \vec{\sigma})$.
      \item Verify the signature is valid $LHSPS.\Verif(\PPP,  (C_0, C_1, C_2, \vec{\pi}), \sigma) = \True$.
      \item Using the commitment verification algorithm to verify that $TC.\Verif(\ck, \com, \SVK, \open) = \True$
      \item Verify that $\vec{\pi}$ is a valid Groth-Sahai proof \wrt  $(C_1, C_2, \vec{C}_{\theta}, \com)$.
      \item If any of the verification fails then halt and return $\bot$, otherwise, output $C_0/(C_1^{x_1}\cdot C_2^{x_2})$.
      \end{enumerate}
    
   	
   	\end{description} 
